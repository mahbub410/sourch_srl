
SELECT CENTER_NAME,COUNT(1) FROM VW_EPAY_RECON_UNSUC_OPT_ERR
WHERE ERROR_TYPE='PAYMVALD'
AND ERROR_TXT LIKE '%This bill no does not exist on BPDB%'
--AND CENTER_NAME<>'TANGAIL' 
GROUP BY CENTER_NAME

DELETE EPAY_UTILITY_BILL_SUP2;

COMMIT;

-----bill number find 

select ''''||bill_number||''''||',' from epay_payment_dtl
where batch_no in (
select batch_no from VW_EPAY_UNTRANSFER_PYMT_ALL
where CENTER_NAME='TANGAIL'
)
minus
select ''''||bill_number||''''||',' from epay_utility_bill
where location_code in ('T7','T4','T2','T3','T5','T6','T1')
and bill_number in (
select bill_number from epay_payment_dtl
where batch_no in (
select batch_no from VW_EPAY_UNTRANSFER_PYMT_ALL
where CENTER_NAME='TANGAIL'
)
)

INSERT INTO EPAY_UTILITY_BILL_SUP2
SELECT 'BPDB' AS COMPANY_CODE, 
CUSTOMER_NUM||CONS_CHK_DIGIT AS ACCOUNT_NUMBER, 
INVOICE_NUM||INVOICE_CHK_DGT BILL_NUMBER, 
INVOICE_DATE GENERATED_DATE, 
'N' BILL_STATUS, 
 INVOICE_DUE_DATE BILL_DUE_DATE, 
  NULL BILLAMT_AFTERDUEDATE, 
  INVOICE_DUE_DATE BILLENDDATE_FORPAYMENT, 
  SYSDATE CREATED_ON    , 
  'SYSADMIN' CREATED_BY   , 
  NULL  MODIFIED_ON , 
  NULL MODIFIED_BY, 
  'N' NOTIFICATION_SENT_STATUS, 
 (NVL(ENG_CHRG_SR,0)+ NVL(ENG_CHRG_OFPK,0)+NVL(ENG_CHRG_PK,0) 
  +NVL(MINIMUM_CHRG,0) +NVL(SERVICE_CHRG,0)+ 
   NVL(DEMAND_CHRG,0) 
   +NVL(XF_RENT,0)+NVL(XF_LOSS_CHRG,0)+NVL(PFC_CHARGE,0)+ 
  NVL(ENG_CHRG_MR1,0)+NVL(ENG_CHRG_MR2,0)+NVL(ENG_CHRG_MR3,0)+NVL(ENG_CHRG_MR4,0)) CURRENT_PRINCIPLE, 
  CURRENT_VAT CURRENT_GOVT_DUTY, 
  ARR_ADV_ADJ_PRN  ARREAR_PRINCIPLE, 
  ARR_ADV_ADJ_VAT ARREAR_GOVT_DUTY, 
  0 LATE_PAYMENT_SURCHARGE, 
  TOTAL_BILL TOTAL_BILL_AMOUNT, 
 LOCATION_CODE, 
 BILL_CYCLE_CODE BILL_MONTH, 
 TARIFF, 
 CUST_STATUS CUSTOMER_TYPE, 
 CURRENT_LPS CURRENT_SURCHARGE, 
 ARR_ADV_ADJ_LPS ARREAR_SURCHARGE, 
 NVL(ADJUSTED_PRN,0)+NVL(ADJUSTED_LPS,0) ADJUSTED_PRINCIPLE, 
 ADJUSTED_VAT ADJUSTED_GOVT_DUTY, 
 0 /*NVL(UNADJUSTED_PRN,0)+NVL(UNADJUSTED_VAT,0)*/ ADVANCE_AMOUNT,0,'N' AS DATA_TRANS_LOG,'T' AS DATA_TRANS_LOG1,'T' AS DATA_TRANS_LOG2,
 'T' AS DATA_TRANS_LOG3,'T' AS DATA_TRANS_LOG4,'N' AS DATA_TRANS_LOG5 
 FROM BC_BILL_IMAGE@BILLING_mymen
 WHERE BILL_CYCLE_CODE=:P_BILL_MONTH  
--TARIFF IN ('A','C','B','D','E','J')
AND INVOICE_NUM||INVOICE_CHK_DGT IN (
'7613935075',
'7613935336',
'7613935589',
'7613950123',
'7613950146',
'7613950152',
'7613950169',
'7613950264',
'7613950459',
'7613950494',
'7613950519',
'7613950531',
'7613950711',
'7613950821',
'7613962221',
'7613962281',
'7613962296',
'7613962304',
'7613962422',
'7613962623',
'7613962646',
'7613965811',
'7614412822',
'7614412868',
'7614412911',
'7614412928',
'7614413000',
'7614413112',
'7614413158',
'7614413201',
'7614413218',
'7614413247',
'7614413253',
'7614413336',
'7614423961',
'7614424081',
'7614424096',
'7614424110',
'7614428697',
'7614776520'
)
and location_Code ='M3'

COMMIT;

/*
update epay_customer_master_data
set location_code='T7'
where account_no in (
SELECT account_number FROM EPAY_UTILITY_BILL_SUP2
where location_code='T7'
)
*/

INSERT INTO EPAY_UTILITY_BILL
SELECT * FROM EPAY_UTILITY_BILL_SUP2


COMMIT;

------------------------------------------------
ERROR THEN BELOW SQL EXEXUTE

DELETE FROM EPAY_UTILITY_BILL
WHERE BILL_MONTH=:BILL_MONTH
AND  (ACCOUNT_NUMBER) IN (
SELECT ACCOUNT_NUMBER FROM EPAY_UTILITY_BILL_SUP2)

commit;

DELETE FROM EPAY_CUSTOMER_MASTER_DATA
WHERE (ACCOUNT_NO) IN (
SELECT ACCOUNT_NUMBER FROM EPAY_UTILITY_BILL_SUP2)

INSERT INTO EPAY_CUSTOMER_MASTER_DATA
(COMPANY_CODE,ACCOUNT_NO,NAME,LOCATION_CODE,AREAR_CODE,ACTIVATION_DATE,STATUS,CREATED_ON ,DUMPING_FOR, CREATED_BY)
SELECT 'BPDB', CUSTOMER_NUM||CHECK_DIGIT,CUSTOMER_NAME,LOCATION_CODE,AREA_CODE,  TO_DATE(START_BILL_CYCLE,'rrrrmm'),
DECODE (CUSTOMER_STATUS_CODE,'C','A','S','A','I') STATUS,  SYSDATE,    'U','ROBIBPDB' 
FROM BC_CUSTOMERS@BILLING_MYMEN
WHERE CUSTOMER_NUM IN (SELECT SUBSTR(ACCOUNT_NUMBER,1,7) FROM EPAY_UTILITY_BILL_SUP2);


COMMIT;



=========DATA BAKUP========

INSERT INTO EPAY_UTILITY_BILL_TNG_MY
SELECT COMPANY_CODE, ACCOUNT_NUMBER, BILL_NUMBER, GENERATED_DATE, BILL_STATUS, BILL_DUE_DATE, 
BILLAMT_AFTERDUEDATE, BILLENDDATE_FORPAYMENT, CREATED_ON, CREATED_BY, MODIFIED_ON, MODIFIED_BY, 
NOTIFICATION_SENT_STATUS, CURRENT_PRINCIPLE, CURRENT_GOVT_DUTY, ARREAR_PRINCIPLE, ARREAR_GOVT_DUTY, 
LATE_PAYMENT_SURCHARGE, TOTAL_BILL_AMOUNT, LOCATION_CODE, BILL_MONTH, TARIFF, CUSTOMER_TYPE, 
CURRENT_SURCHARGE, ARREAR_SURCHARGE, ADJUSTED_PRINCIPLE, ADJUSTED_GOVT_DUTY, ADVANCE_AMOUNT, ADJ_ADV_GOVT_DUTY 
FROM EPAY_UTILITY_BILL
WHERE BILL_MONTH=:BILL_MONTH
AND  (ACCOUNT_NUMBER) IN (
SELECT ACCOUNT_NUMBER FROM EPAY_UTILITY_BILL_SUP2)

COMMIT;

select * from epay_customer_master_data
where account_no in (
'75956394',
'75956445'
)

select * from EPAY_UTILITY_BILL
where account_number='75956394'
and bill_month='202106'
